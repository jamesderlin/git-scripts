#!/usr/bin/env python3

"""
Generates a diff for a single git commit.
"""

import argparse
import os
import subprocess
import sys

def main(argv):
    globals()["__name__"] = argv[0]

    ap = argparse.ArgumentParser(description=__doc__.strip(), add_help=False)
    ap.add_argument("-h", "--help", action="help",
                    help="Show this help message and exit.")
    ap.add_argument("commit", metavar="COMMIT", nargs="?", default="HEAD",
                    help="The email subject.")

    args = ap.parse_args(argv[1:])

    args = ("git", "rev-parse", "--verify", args.commit)
    result = subprocess.run(args,
                            stdout=subprocess.PIPE,
                            universal_newlines=True)
    if result.returncode != 0:
        return result.returncode

    commit = result.stdout.strip()

    args = ("git", "diff", commit + "~", commit)
    result = subprocess.run(args, bufsize=1)
    return result.returncode

if __name__ == "__main__":
    sys.argv[0] = os.path.basename(sys.argv[0])
    sys.exit(main(sys.argv))

